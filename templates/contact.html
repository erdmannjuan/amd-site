{% extends "base.html" %}

{% block content %}
<!-- Page Hero -->
<section class="page-hero">
    <div class="container">
        <span class="section-label">{{ page.label or "Contact" }}</span>
        <h1 class="page-title">{{ page.hero_title or "Contact Us" }}</h1>
        <p class="page-subtitle">{{ page.hero_subtitle or "Let's discuss your automation project" }}</p>
    </div>
</section>

<!-- Contact Section -->
<section class="section">
    <div class="container">
        <div class="contact-grid">
            <!-- Contact Info -->
            <div class="contact-info">
                <figure class="contact-image">
                    <img src="{{ config.site.base_path }}/static/images/contact-automation.jpg"
                         alt="ABB robot performing precision assembly automation at AMD Machines facility"
                         width="600" height="220"
                         loading="lazy">
                </figure>
                <h2>Get in Touch</h2>
                <p>Ready to discuss your automation project? Our team is here to help. Reach out to start a conversation about your manufacturing challenges.</p>

                <div class="contact-methods">
                    <div class="contact-method">
                        <div class="contact-icon contact-icon-phone"></div>
                        <div>
                            <h3>Phone</h3>
                            <p><a href="tel:{{ config.social.phone | replace('(', '') | replace(')', '') | replace(' ', '') | replace('-', '') }}">{{ config.social.phone }}</a></p>
                        </div>
                    </div>

                    <div class="contact-method">
                        <div class="contact-icon contact-icon-location"></div>
                        <div>
                            <h3>Address</h3>
                            <p>{{ config.social.address }}</p>
                        </div>
                    </div>
                </div>

                {% if page.hours %}
                <div class="business-hours">
                    <h3>Business Hours</h3>
                    <ul>
                        {% for hour in page.hours %}
                        <li><strong>{{ hour.days }}:</strong> {{ hour.time }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>

            <!-- Contact Form -->
            <div class="contact-form-wrapper">
                <h2>Request a Quote</h2>
                <div class="response-time-badge">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>
                    <span>We respond in under 3 hours during weekdays</span>
                </div>
                <p>Fill out the form below and our engineering team will reach out to discuss your project.</p>

                <form class="contact-form" id="contact-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstname">First Name *</label>
                            <input type="text" id="firstname" name="firstname" required>
                        </div>
                        <div class="form-group">
                            <label for="lastname">Last Name *</label>
                            <input type="text" id="lastname" name="lastname" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone</label>
                            <input type="tel" id="phone" name="phone">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="company">Company *</label>
                            <input type="text" id="company" name="company" required>
                        </div>
                        <div class="form-group">
                            <label for="project_type">Project Type</label>
                            <select id="project_type" name="project_type">
                                <option value="">Select a project type</option>
                                <option value="Robotic Cells">Robotic Cells</option>
                                <option value="Welding Automation">Welding Automation</option>
                                <option value="Test Systems">Test Systems</option>
                                <option value="Assembly Machines">Assembly Machines</option>
                                <option value="Custom Automation">Custom Automation</option>
                                <option value="Material Handling">Material Handling</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="message">Project Description *</label>
                        <textarea id="message" name="message" rows="5" required placeholder="Tell us about your project, including parts, volumes, and any specific requirements."></textarea>
                    </div>

                    <div id="form-status" class="form-status"></div>

                    <button type="submit" class="btn btn-primary btn-lg btn-block" id="submit-btn">Submit Request</button>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Content from markdown (if any) -->
{% if content %}
<section class="section section-alt">
    <div class="container">
        <div class="content-body">
            {{ content | safe }}
        </div>
    </div>
</section>
{% endif %}
{% endblock %}

{% block scripts_extra %}
<script>
// HubSpot Form Integration with reCAPTCHA v3
(function() {
    // Configuration
    const HUBSPOT_PORTAL_ID = '{{ config.hubspot.portal_id | default("YOUR_PORTAL_ID") }}';
    const HUBSPOT_FORM_ID = '{{ config.hubspot.form_id | default("YOUR_FORM_ID") }}';
    const RECAPTCHA_SITE_KEY = '6LdSKVIsAAAAAAcVpAO4PCEzDjEmGOpfo1jK0wMS';

    const form = document.getElementById('contact-form');
    const submitBtn = document.getElementById('submit-btn');
    const formStatus = document.getElementById('form-status');

    if (!form) return;

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Check if HubSpot is configured
        if (HUBSPOT_PORTAL_ID === 'YOUR_PORTAL_ID' || HUBSPOT_FORM_ID === 'YOUR_FORM_ID') {
            formStatus.innerHTML = '<p class="error">Form not configured. Please contact us directly.</p>';
            return;
        }

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.textContent = 'Verifying...';
        formStatus.innerHTML = '';

        try {
            // Get reCAPTCHA token
            if (typeof grecaptcha === 'undefined') {
                throw new Error('reCAPTCHA not loaded');
            }

            const recaptchaToken = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'contact_form' });

            submitBtn.textContent = 'Sending...';

            // Collect form data - using HubSpot default field names
            const projectType = document.getElementById('project_type').value;
            const messageText = document.getElementById('message').value;
            const fullMessage = projectType ? `[Project Type: ${projectType}]\n\n${messageText}` : messageText;

            const formData = {
                fields: [
                    { name: 'firstname', value: document.getElementById('firstname').value },
                    { name: 'lastname', value: document.getElementById('lastname').value },
                    { name: 'email', value: document.getElementById('email').value },
                    { name: 'phone', value: document.getElementById('phone').value || '' },
                    { name: 'company', value: document.getElementById('company').value },
                    { name: 'message', value: fullMessage }
                ],
                context: {
                    pageUri: window.location.href,
                    pageName: document.title
                }
            };

            const response = await fetch(
                `https://api.hsforms.com/submissions/v3/integration/submit/${HUBSPOT_PORTAL_ID}/${HUBSPOT_FORM_ID}`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                }
            );

            if (response.ok) {
                // Track successful form submission in GA4
                if (typeof gtag === 'function') {
                    gtag('event', 'form_submission', {
                        event_category: 'lead',
                        event_label: 'contact_form',
                        value: 1
                    });
                }
                formStatus.innerHTML = '<p class="success">Thank you! Your request has been submitted. Expect a response from our team within 3 hours during weekdays.</p>';
                form.reset();
            } else {
                const errorData = await response.json();
                console.error('HubSpot error:', errorData);
                formStatus.innerHTML = '<p class="error">There was an error submitting your request. Please try again or contact us directly.</p>';
            }
        } catch (error) {
            console.error('Submission error:', error);
            formStatus.innerHTML = '<p class="error">There was an error submitting your request. Please try again or contact us directly.</p>';
        }

        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Request';
    });
})();
</script>
{% endblock %}
