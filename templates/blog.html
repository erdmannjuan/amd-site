{% extends "base.html" %}

{% block content %}
<!-- Page Hero -->
<section class="page-hero">
    <div class="container">
        <span class="section-label">{{ page.label or "Blog" }}</span>
        <h1 class="page-title">{{ page.hero_title or "Automation Insights" }}</h1>
        <p class="page-subtitle">{{ page.hero_subtitle or "Expert perspectives on manufacturing automation, robotics, and industry trends" }}</p>
    </div>
</section>

<!-- Search Bar -->
<section class="blog-search-section">
    <div class="container">
        <div class="blog-search-wrapper">
            <div class="blog-search-box">
                <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <input type="text" id="blog-search" placeholder="Search {{ pagination.total_posts if pagination else posts|length }} articles..." autocomplete="off">
                <button id="clear-search" class="clear-search" style="display: none;">×</button>
            </div>
            <div class="blog-search-results" id="search-results" style="display: none;">
                <div class="search-results-list" id="search-results-list"></div>
            </div>
        </div>
        <div class="blog-filter-row">
            <div class="filter-group">
                <select id="category-filter">
                    <option value="">All Categories</option>
                    {% for category in categories|sort %}
                    <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <select id="date-filter">
                    <option value="">All Years</option>
                    <option value="2026">2026</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                </select>
            </div>
            <button id="clear-filters" class="btn-text" style="display: none;">Clear filters</button>
        </div>
    </div>
</section>

<!-- Blog Grid -->
<section class="section blog-section">
    <div class="container">
        <div class="blog-grid" id="blog-grid">
            {% for post in posts %}
            <article class="blog-card" data-category="{{ post.category or '' }}" data-date="{{ post.date or '' }}" data-title="{{ post.title|lower }}" data-description="{{ post.description|lower }}">
                {% if post.image %}
                <div class="blog-card-image">
                    <img src="{{ config.site.base_path }}/static/images/{{ post.image }}" alt="{{ post.title }}" loading="lazy" width="800" height="450">
                </div>
                {% endif %}
                <div class="blog-card-body">
                    {% if post.category %}
                    <span class="blog-category">{{ post.category }}</span>
                    {% endif %}
                    <h2><a href="{{ config.site.base_path }}{{ post.url }}">{{ post.title }}</a></h2>
                    <p>{{ post.description }}</p>
                    <div class="blog-meta">
                        {% if post.author %}<span>{{ post.author }}</span>{% endif %}
                        {% if post.date %}<span>{{ post.date }}</span>{% endif %}
                        {% if post.read_time %}<span>{{ post.read_time }} min read</span>{% endif %}
                    </div>
                </div>
            </article>
            {% else %}
            <div class="blog-empty">
                <p>No blog posts yet. Check back soon for automation insights and industry updates.</p>
            </div>
            {% endfor %}
        </div>
        <div class="blog-empty" id="no-results" style="display: none;">
            <p>No articles match your filters. Try adjusting your search criteria.</p>
        </div>

        {% if pagination and pagination.total_pages > 1 %}
        <!-- Pagination -->
        <nav class="blog-pagination" aria-label="Blog pagination">
            {% if pagination.has_prev %}
            <a href="{{ config.site.base_path }}{{ pagination.prev_url }}" class="pagination-btn pagination-prev">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15,18 9,12 15,6"/></svg>
                Previous
            </a>
            {% else %}
            <span class="pagination-btn pagination-prev disabled">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15,18 9,12 15,6"/></svg>
                Previous
            </span>
            {% endif %}

            <div class="pagination-numbers">
                {% for page_num in pagination.pages %}
                    {% if page_num == pagination.current_page %}
                    <span class="pagination-num active">{{ page_num }}</span>
                    {% elif page_num == 1 %}
                    <a href="{{ config.site.base_path }}/blog/" class="pagination-num">{{ page_num }}</a>
                    {% elif page_num <= 3 or page_num > pagination.total_pages - 2 or (page_num >= pagination.current_page - 1 and page_num <= pagination.current_page + 1) %}
                    <a href="{{ config.site.base_path }}/blog/page/{{ page_num }}/" class="pagination-num">{{ page_num }}</a>
                    {% elif page_num == 4 and pagination.current_page > 5 %}
                    <span class="pagination-ellipsis">...</span>
                    {% elif page_num == pagination.total_pages - 2 and pagination.current_page < pagination.total_pages - 4 %}
                    <span class="pagination-ellipsis">...</span>
                    {% endif %}
                {% endfor %}
            </div>

            {% if pagination.has_next %}
            <a href="{{ config.site.base_path }}{{ pagination.next_url }}" class="pagination-btn pagination-next">
                Next
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9,6 15,12 9,18"/></svg>
            </a>
            {% else %}
            <span class="pagination-btn pagination-next disabled">
                Next
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9,6 15,12 9,18"/></svg>
            </span>
            {% endif %}
        </nav>
        {% endif %}
    </div>
</section>

<!-- CTA Section -->
<section class="cta-section">
    <div class="container">
        <h2>Stay Updated</h2>
        <p>Get the latest automation insights delivered to your inbox.</p>
        <a href="{{ config.site.base_path }}/contact/" class="btn btn-white btn-lg">Subscribe</a>
    </div>
</section>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const searchInput = document.getElementById('blog-search');
    const searchResults = document.getElementById('search-results');
    const searchResultsList = document.getElementById('search-results-list');
    const clearSearch = document.getElementById('clear-search');
    const categoryFilter = document.getElementById('category-filter');
    const dateFilter = document.getElementById('date-filter');
    const clearFilters = document.getElementById('clear-filters');
    const blogGrid = document.getElementById('blog-grid');
    const noResults = document.getElementById('no-results');
    const cards = document.querySelectorAll('.blog-card');

    let searchIndex = null;
    let searchTimeout = null;

    // Load search index on first search interaction
    async function loadSearchIndex() {
        if (searchIndex) return searchIndex;
        try {
            const response = await fetch('{{ config.site.base_path }}/blog/search-index.json');
            searchIndex = await response.json();
            return searchIndex;
        } catch (e) {
            console.error('Failed to load search index:', e);
            return [];
        }
    }

    // Search function
    async function performSearch(query) {
        if (!query || query.length < 2) {
            searchResults.style.display = 'none';
            clearSearch.style.display = 'none';
            return;
        }

        clearSearch.style.display = 'block';
        const posts = await loadSearchIndex();
        const q = query.toLowerCase();

        const results = posts.filter(post => {
            const title = (post.title || '').toLowerCase();
            const desc = (post.description || '').toLowerCase();
            const cat = (post.category || '').toLowerCase();
            return title.includes(q) || desc.includes(q) || cat.includes(q);
        }).slice(0, 8); // Limit to 8 results

        if (results.length === 0) {
            searchResultsList.innerHTML = '<div class="search-no-results">No articles found for "' + query + '"</div>';
        } else {
            searchResultsList.innerHTML = results.map(post => `
                <a href="{{ config.site.base_path }}${post.url}" class="search-result-item">
                    <span class="search-result-category">${post.category || 'Article'}</span>
                    <span class="search-result-title">${post.title}</span>
                    <span class="search-result-meta">${post.date || ''} · ${post.read_time || 5} min read</span>
                </a>
            `).join('');
        }

        searchResults.style.display = 'block';
    }

    // Search input handler with debounce
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => performSearch(this.value.trim()), 200);
    });

    // Clear search
    clearSearch.addEventListener('click', function() {
        searchInput.value = '';
        searchResults.style.display = 'none';
        clearSearch.style.display = 'none';
        searchInput.focus();
    });

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.blog-search-wrapper')) {
            searchResults.style.display = 'none';
        }
    });

    // Show results on focus if there's a query
    searchInput.addEventListener('focus', function() {
        if (this.value.trim().length >= 2) {
            performSearch(this.value.trim());
        }
    });

    // Keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            searchResults.style.display = 'none';
            this.blur();
        }
    });

    // Filter cards on current page
    function filterPageCards() {
        const category = categoryFilter.value;
        const year = dateFilter.value;
        let visibleCount = 0;

        cards.forEach(function(card) {
            const cardCategory = card.dataset.category || '';
            const cardDate = card.dataset.date || '';
            let show = true;

            if (category && cardCategory !== category) show = false;
            if (year && !cardDate.startsWith(year)) show = false;

            card.style.display = show ? '' : 'none';
            if (show) visibleCount++;
        });

        noResults.style.display = visibleCount === 0 ? 'block' : 'none';
        blogGrid.style.display = visibleCount === 0 ? 'none' : '';
        clearFilters.style.display = (category || year) ? 'inline' : 'none';
    }

    categoryFilter.addEventListener('change', filterPageCards);
    dateFilter.addEventListener('change', filterPageCards);

    clearFilters.addEventListener('click', function() {
        categoryFilter.value = '';
        dateFilter.value = '';
        filterPageCards();
    });

    // Handle URL params
    const urlParams = new URLSearchParams(window.location.search);
    const urlCategory = urlParams.get('category');
    if (urlCategory) {
        const decoded = decodeURIComponent(urlCategory);
        const options = categoryFilter.querySelectorAll('option');
        for (let opt of options) {
            if (opt.value.toLowerCase() === decoded.toLowerCase()) {
                categoryFilter.value = opt.value;
                break;
            }
        }
        filterPageCards();
    }
});
</script>
{% endblock %}
