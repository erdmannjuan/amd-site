{% extends "base.html" %}

{% block head_extra %}
<style>
    /* TOC Active State */
    .toc-link.active {
        color: var(--primary);
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<!-- Article Header - Compact -->
<section class="article-header-compact">
    <div class="container">
        <div class="article-header-content">
            <nav class="breadcrumb-inline">
                <a href="{{ config.site.base_path }}/">Home</a>
                <span class="sep">/</span>
                <a href="{{ config.site.base_path }}/blog/">Blog</a>
                <span class="sep">/</span>
                {% if page.category %}<span class="cat">{{ page.category }}</span>{% endif %}
            </nav>
            <h1 class="article-title-slim">{{ page.title }}</h1>
            <div class="article-header-row">
                <div class="article-meta-inline">
                    {% if page.date %}<span class="date">{{ page.date }}</span>{% endif %}
                    {% if page.read_time %}<span class="read-time">{{ page.read_time }} min read</span>{% endif %}
                </div>
                <div class="share-buttons-top">
                    <button class="share-btn" onclick="copyLink()" title="Copy link">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                        <span>Copy</span>
                    </button>
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ config.site.url }}{{ page.url }}&title={{ page.title }}" target="_blank" rel="noopener" class="share-btn share-linkedin" title="Share on LinkedIn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                    </a>
                    <a href="https://twitter.com/intent/tweet?url={{ config.site.url }}{{ page.url }}&text={{ page.title }}" target="_blank" rel="noopener" class="share-btn share-x" title="Share on X">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Article Content with Sidebars -->
<section class="section article-section">
    <div class="container">
        <div class="article-layout">
            <!-- Left Sidebar: Table of Contents -->
            <aside class="article-sidebar article-toc">
                <div class="toc-wrapper">
                    <h3>Contents</h3>
                    <nav class="toc-nav" id="toc-nav">
                        <!-- TOC will be generated by JavaScript -->
                    </nav>
                </div>
            </aside>

            <!-- Main Article Content -->
            <article class="article-content">
                {% if page.image %}
                <div class="article-featured-image">
                    <img src="{{ config.site.base_path }}/static/images/{{ page.image }}" alt="{{ page.title }}" loading="lazy" width="800" height="450">
                </div>
                {% endif %}

                <div class="article-body" id="article-body">
                    {{ content | safe }}
                </div>

                <!-- Mid-Article CTA -->
                <div class="article-cta-box">
                    <div class="article-cta-content">
                        <strong>Ready to automate?</strong>
                        <p>Our engineering team can help evaluate your automation needs.</p>
                    </div>
                    <a href="{{ config.site.base_path }}/contact/" class="btn btn-primary-flat">Get a Quote</a>
                </div>

                <!-- Related Solutions -->
                <div class="article-related-solutions">
                    <h3>Explore Related Solutions</h3>
                    <div class="related-solutions-grid">
                        <a href="{{ config.site.base_path }}/solutions/robotic-cells/" class="related-solution-link">
                            <span class="solution-name">Robotic Cells</span>
                            <span class="solution-arrow">→</span>
                        </a>
                        <a href="{{ config.site.base_path }}/solutions/assembly/" class="related-solution-link">
                            <span class="solution-name">Assembly Systems</span>
                            <span class="solution-arrow">→</span>
                        </a>
                        <a href="{{ config.site.base_path }}/solutions/machine-vision/" class="related-solution-link">
                            <span class="solution-name">Machine Vision</span>
                            <span class="solution-arrow">→</span>
                        </a>
                        <a href="{{ config.site.base_path }}/solutions/test-systems/" class="related-solution-link">
                            <span class="solution-name">Test Systems</span>
                            <span class="solution-arrow">→</span>
                        </a>
                    </div>
                </div>

            </article>

            <!-- Right Sidebar: Related Articles -->
            <aside class="article-sidebar article-related" data-test="sidebar_related">
                <div class="related-wrapper">
                    <h3>Related Articles</h3>
                    {% if page.related_posts %}
                    <div class="related-posts">
                        {% for related in page.related_posts %}
                        <a href="{{ config.site.base_path }}{{ related.url }}" class="related-post-card">
                            <div class="related-post-image">
                                <img src="{{ config.site.base_path }}/static/images/{{ related.image | default('placeholder-blog-thumb.svg') }}" alt="{{ related.title }}" loading="lazy" width="280" height="140">
                            </div>
                            <div class="related-post-content">
                                <h4>{{ related.title }}</h4>
                                {% if related.description %}
                                <p>{{ related.description }}</p>
                                {% endif %}
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="no-related">More articles coming soon.</p>
                    {% endif %}

                    <!-- CTA Box -->
                    <div class="sidebar-cta">
                        <h4>Ready to Automate?</h4>
                        <p>Let's discuss your automation project.</p>
                        <a href="{{ config.site.base_path }}/contact/" class="btn btn-primary btn-sm">Get a Quote</a>
                    </div>
                </div>
            </aside>
        </div>
    </div>
</section>

<!-- More Articles -->
<section class="section section-alt related-content" data-test="related_content">
    <div class="container">
        <div class="section-header">
            <span class="section-label">Keep Reading</span>
            <h2 class="section-title">More from the Blog</h2>
        </div>
        <div class="related-grid">
            {% for post in posts[:4] %}
            {% if post.url != page.url %}
            <a href="{{ config.site.base_path }}{{ post.url }}" class="related-item" data-content-id="{{ post.title | lower | replace(' ', '-') | truncate(30, True, '') }}">
                <div class="related-item-inner">
                    {% if post.category %}
                    <span class="related-category">{{ post.category }}</span>
                    {% endif %}
                    <h3>{{ post.title }}</h3>
                    <p>{{ post.description }}</p>
                    <span class="related-link">Read Article →</span>
                </div>
            </a>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</section>
{% endblock %}

{% block scripts_extra %}
<script>
// Generate Table of Contents from H2 headings
document.addEventListener('DOMContentLoaded', function() {
    const articleBody = document.getElementById('article-body');
    const tocNav = document.getElementById('toc-nav');

    if (!articleBody || !tocNav) return;

    const headings = articleBody.querySelectorAll('h2');

    if (headings.length === 0) {
        tocNav.innerHTML = '<p class="toc-empty">No sections</p>';
        return;
    }

    const tocList = document.createElement('ul');
    tocList.className = 'toc-list';

    headings.forEach((heading, index) => {
        // Add ID to heading if not present
        if (!heading.id) {
            heading.id = 'section-' + index;
        }

        const listItem = document.createElement('li');
        const link = document.createElement('a');
        link.href = '#' + heading.id;
        link.textContent = heading.textContent;
        link.className = 'toc-link';

        listItem.appendChild(link);
        tocList.appendChild(listItem);
    });

    tocNav.appendChild(tocList);

    // Highlight active section on scroll
    const tocLinks = tocNav.querySelectorAll('.toc-link');

    function updateActiveLink() {
        const scrollPos = window.scrollY + 150;

        headings.forEach((heading, index) => {
            const nextHeading = headings[index + 1];
            const sectionTop = heading.offsetTop;
            const sectionBottom = nextHeading ? nextHeading.offsetTop : document.body.scrollHeight;

            if (scrollPos >= sectionTop && scrollPos < sectionBottom) {
                tocLinks.forEach(link => link.classList.remove('active'));
                tocLinks[index].classList.add('active');
            }
        });
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});

// Copy link function
function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(function() {
        const btn = document.querySelector('.share-btn[onclick="copyLink()"]');
        const originalText = btn.querySelector('span').textContent;
        btn.querySelector('span').textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(function() {
            btn.querySelector('span').textContent = originalText;
            btn.classList.remove('copied');
        }, 2000);
    });
}
</script>
{% endblock %}
