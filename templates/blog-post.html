{% extends "base.html" %}

{% block head_extra %}
<style>
    /* TOC Active State */
    .toc-link.active {
        color: var(--primary);
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<!-- Article Header -->
<section class="article-hero">
    <div class="container">
        <nav class="breadcrumb">
            <a href="{{ config.site.base_path }}/">Home</a> &rsaquo;
            <a href="{{ config.site.base_path }}/blog/">Blog</a> &rsaquo;
            <span>{{ page.title }}</span>
        </nav>
        {% if page.category %}
        <span class="article-category">{{ page.category }}</span>
        {% endif %}
        <h1 class="article-title">{{ page.title }}</h1>
        {% if page.description %}
        <p class="article-subtitle">{{ page.description }}</p>
        {% endif %}
        <div class="article-meta">
            {% if page.author %}<span class="author">By {{ page.author }}</span>{% endif %}
            {% if page.date %}<span class="date">{{ page.date }}</span>{% endif %}
            {% if page.read_time %}<span class="read-time">{{ page.read_time }} min read</span>{% endif %}
        </div>
    </div>
</section>

<!-- Article Content with Sidebars -->
<section class="section article-section">
    <div class="container">
        <div class="article-layout">
            <!-- Left Sidebar: Table of Contents -->
            <aside class="article-sidebar article-toc">
                <div class="toc-wrapper">
                    <h3>Contents</h3>
                    <nav class="toc-nav" id="toc-nav">
                        <!-- TOC will be generated by JavaScript -->
                    </nav>
                </div>
            </aside>

            <!-- Main Article Content -->
            <article class="article-content">
                {% if page.image %}
                <div class="article-featured-image">
                    <img src="{{ config.site.base_path }}/static/images/{{ page.image }}" alt="{{ page.title }}" loading="lazy" width="800" height="450">
                </div>
                {% endif %}

                <div class="article-body" id="article-body">
                    {{ content | safe }}
                </div>

                <!-- Author Box -->
                {% if page.author %}
                <div class="author-box">
                    <div class="author-info">
                        <h4>{{ page.author }}</h4>
                        {% if page.author_title %}
                        <span>{{ page.author_title }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Share Links -->
                <div class="share-section">
                    <span>Share this article:</span>
                    <div class="share-links">
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ config.site.url }}{{ page.url }}&title={{ page.title }}" target="_blank" rel="noopener" class="share-link">LinkedIn</a>
                        <a href="https://twitter.com/intent/tweet?url={{ config.site.url }}{{ page.url }}&text={{ page.title }}" target="_blank" rel="noopener" class="share-link">Twitter</a>
                    </div>
                </div>
            </article>

            <!-- Right Sidebar: Related Articles -->
            <aside class="article-sidebar article-related">
                <div class="related-wrapper">
                    <h3>Related Articles</h3>
                    {% if page.related_posts %}
                    <div class="related-posts">
                        {% for related in page.related_posts %}
                        <a href="{{ config.site.base_path }}{{ related.url }}" class="related-post">
                            <h4>{{ related.title }}</h4>
                            {% if related.description %}
                            <p>{{ related.description }}</p>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="no-related">More articles coming soon.</p>
                    {% endif %}

                    <!-- CTA Box -->
                    <div class="sidebar-cta">
                        <h4>Ready to Automate?</h4>
                        <p>Let's discuss your automation project.</p>
                        <a href="{{ config.site.base_path }}/contact/" class="btn btn-primary btn-sm">Get a Quote</a>
                    </div>
                </div>
            </aside>
        </div>
    </div>
</section>

<!-- More Articles with A/B Testing -->
<section class="section section-alt related-content" data-test="related_content">
    <div class="container">
        <div class="section-header text-center">
            <span class="section-label">Keep Reading</span>
            <h2 class="section-title">More from the Blog</h2>
        </div>
        <div class="related-grid">
            {% for post in posts[:4] %}
            {% if post.url != page.url %}
            <a href="{{ config.site.base_path }}{{ post.url }}" class="related-item" data-content-id="{{ post.title | lower | replace(' ', '-') | truncate(30, True, '') }}">
                <div class="related-item-inner">
                    {% if post.category %}
                    <span class="related-category">{{ post.category }}</span>
                    {% endif %}
                    <h3>{{ post.title }}</h3>
                    <p>{{ post.description }}</p>
                    <span class="related-link">Read Article â†’</span>
                </div>
            </a>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</section>
{% endblock %}

{% block scripts_extra %}
<script>
// Generate Table of Contents from H2 headings
document.addEventListener('DOMContentLoaded', function() {
    const articleBody = document.getElementById('article-body');
    const tocNav = document.getElementById('toc-nav');

    if (!articleBody || !tocNav) return;

    const headings = articleBody.querySelectorAll('h2');

    if (headings.length === 0) {
        tocNav.innerHTML = '<p class="toc-empty">No sections</p>';
        return;
    }

    const tocList = document.createElement('ul');
    tocList.className = 'toc-list';

    headings.forEach((heading, index) => {
        // Add ID to heading if not present
        if (!heading.id) {
            heading.id = 'section-' + index;
        }

        const listItem = document.createElement('li');
        const link = document.createElement('a');
        link.href = '#' + heading.id;
        link.textContent = heading.textContent;
        link.className = 'toc-link';

        listItem.appendChild(link);
        tocList.appendChild(listItem);
    });

    tocNav.appendChild(tocList);

    // Highlight active section on scroll
    const tocLinks = tocNav.querySelectorAll('.toc-link');

    function updateActiveLink() {
        const scrollPos = window.scrollY + 150;

        headings.forEach((heading, index) => {
            const nextHeading = headings[index + 1];
            const sectionTop = heading.offsetTop;
            const sectionBottom = nextHeading ? nextHeading.offsetTop : document.body.scrollHeight;

            if (scrollPos >= sectionTop && scrollPos < sectionBottom) {
                tocLinks.forEach(link => link.classList.remove('active'));
                tocLinks[index].classList.add('active');
            }
        });
    }

    window.addEventListener('scroll', updateActiveLink);
    updateActiveLink();
});
</script>
{% endblock %}
